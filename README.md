# AddUp.FakeRabbitMQ

[![Build](https://github.com/addupsolutions/AddUp.RabbitMQ.Fakes/workflows/Build/badge.svg)](https://github.com/addupsolutions/AddUp.FakeRabbitMQ/actions?query=workflow%3ABuild)
[![Quality Gate Status](https://sonarcloud.io/api/project_badges/measure?project=addupsolutions_AddUp.FakeRabbitMQ&metric=alert_status)](https://sonarcloud.io/dashboard?id=addupsolutions_AddUp.FakeRabbitMQ)
[![Coverage](https://sonarcloud.io/api/project_badges/measure?project=addupsolutions_AddUp.FakeRabbitMQ&metric=coverage)](https://sonarcloud.io/dashboard?id=addupsolutions_AddUp.FakeRabbitMQ)
[![NuGet](https://img.shields.io/nuget/v/AddUp.FakeRabbitMQ.svg)](https://www.nuget.org/packages/AddUp.FakeRabbitMQ/)

## Important Notice

On _2020/10/04_, and starting with version 1.2.3, **AddUp.RabbitMQ.Fakes** was renamed to **AddUp.FakeRabbitMQ**. This concerns:

* This repository name: <https://github.com/addupsolutions/AddUp.FakeRabbitMQ>,
* The Nuget package name: <https://www.nuget.org/packages/AddUp.FakeRabbitMQ/>,
* The Assembly name: `AddUp.FakeRabbitMQ.dll`.

However, the root namespace remains (for compatibility purpose) `AddUp.RabbitMQ.Fakes`.

I deemed this renaming necessary as the `Fakes` suffix collides with [Microsoft Fakes](https://docs.microsoft.com/en-us/visualstudio/test/isolating-code-under-test-with-microsoft-fakes?view=vs-2019) product. Because the assembly name ends with `.Fakes`, several unit-test related tools consider it not to be a _real_ assembly but rather something generated by **Microsoft Fakes**.

## About

**AddUp.FakeRabbitMQ** is a fork of <https://github.com/Parametric/RabbitMQ.Fakes>. Thanks to the folks over there for their work without which our own version would probably never have been possible.

**AddUp.FakeRabbitMQ** provides fake implementations of the **RabbitMQ.Client** interfaces (see <https://www.nuget.org/packages/RabbitMQ.Client> for the nuget package and <https://github.com/rabbitmq/rabbitmq-dotnet-client> for its source code). They are intended to be used for testing so that unit tests that depend on RabbitMQ can be executed fully in memory withouth needing an external RabbitMQ server.

**AddUp.FakeRabbitMQ** builds on top of the original project:

* Targets **.NET Standard 2.0**
* Supports Default, Direct, Topic and Fanout exchange types.
  * _NB: Headers exchange type is not supported; however, it won't throw (it is implemented the same way as the Fanout type)_

## Hall of fame

<!-- https://github.com/search?q=repo%3Aaddupsolutions%2FAddUp.FakeRabbitMQ%20is%3Apr%20-author%3Aapp%2Fdependabot%20-author%3Aapp%2Fdependabot-preview&type=pullrequests -->

Thanks to all the contributors:

* [@inbarbarkai](https://github.com/inbarbarkai)
* [@Quogu](https://github.com/Quogu)
* [@patrikwlund](https://github.com/patrikwlund)
* [@marcusber](https://github.com/marcusber)

## History

> Versions 1.x are based on [RabbitMQ .NET client Version 5.x](https://www.nuget.org/packages/RabbitMQ.Client/5.2.0)
>
> Versions 2.x are based on [RabbitMQ .NET client Version 6.x](https://www.nuget.org/packages/RabbitMQ.Client/6.2.4)

### [Version 2.8.0 - 2023/11/13](https://github.com/addupsolutions/AddUp.FakeRabbitMQ/releases/tag/v2.8.0)

* Fixed [Issue #180](https://github.com/addupsolutions/AddUp.FakeRabbitMQ/issues/180): Now non-AutoAck scenarios work better (not sure though if they are completely equivalent to what a real RabbitMQ instance would do). Thanks to [@manuelspezzani](https://github.com/manuelspezzani) for providing repro unit tests.

> Note that this version might be _technically_ breaking as some `public` members are now either `internal` or implemented rather differently.
  Anyway those are implementation details and should not be used from client code. I intend to internalize more implementation details in the future so as to not leak abstractions.

> Also note that this is far from being bulletproof: The unit tests associated with issue [#180](https://github.com/addupsolutions/AddUp.FakeRabbitMQ/issues/180) pass, but there are still many scenarios that do not work the same as with a real RabbitMQ server (for example, do not try to requeue a `nacked` message, it won't work).

### [Version 2.7.0 - 2023/10/16](https://github.com/addupsolutions/AddUp.FakeRabbitMQ/releases/tag/v2.7.0)

* Updated **RabbitMQ.Client** to version [6.6.0](https://github.com/rabbitmq/rabbitmq-dotnet-client/releases/tag/v6.6.0) thanks to [@marcusber](https://github.com/marcusber)'s [PR #174](https://github.com/addupsolutions/AddUp.FakeRabbitMQ/pull/174)

### [Version 2.6.0 - 2023/03/29](https://github.com/addupsolutions/AddUp.FakeRabbitMQ/releases/tag/v2.6.0)

* Updated **RabbitMQ.Client** to version [6.5.0](https://github.com/rabbitmq/rabbitmq-dotnet-client/blob/main/CHANGELOG.md#v650-2023-03-24)

### [Version 2.5.0 - 2022/12/14](https://github.com/addupsolutions/AddUp.FakeRabbitMQ/releases/tag/v2.5.0)

Two contributions by [@patrikwlund](https://github.com/patrikwlund):

* Better compliance: No more unique singleton-based connection. See [PR #122](https://github.com/addupsolutions/AddUp.FakeRabbitMQ/pull/122) for details.
* New feature: by passing a boolean to the constructor of `AddUp.RabbitMQ.Fakes.RabbitServer`, one can opt into using blocking delivery (the default remains non-blocking). This helps simplifying unit tests in scenarios where one is not interested in simulating a real RabbitMQ behavior (avoids asynchronous waiting for messages delivery). See [PR #123](https://github.com/addupsolutions/AddUp.FakeRabbitMQ/pull/123) for details.

### [Version 2.4.0 - 2022/12/11](https://github.com/addupsolutions/AddUp.FakeRabbitMQ/releases/tag/v2.4.0)

* [@patrikwlund](https://github.com/patrikwlund) improved the performance of [PR #118](https://github.com/addupsolutions/AddUp.FakeRabbitMQ/pull/118). See [PR #121](https://github.com/addupsolutions/AddUp.FakeRabbitMQ/pull/121) for details.
* Yet another set of improvements by [@Quogu](https://github.com/Quogu). See [PR #120](https://github.com/addupsolutions/AddUp.FakeRabbitMQ/pull/120) for details.

### [Version 2.3.0 - 2022/12/03](https://github.com/addupsolutions/AddUp.FakeRabbitMQ/releases/tag/v2.3.0)

Another pair of improvements by [@Quogu](https://github.com/Quogu):

* Better compliance: A unique consumer tag is now generated when the calling code does not provide any. See [PR #117](https://github.com/addupsolutions/AddUp.FakeRabbitMQ/pull/117) for details.
* Better underlying delivery model (using `Task`s). Should reduce deadlock issues in Test code. See [PR #118](https://github.com/addupsolutions/AddUp.FakeRabbitMQ/pull/118) for details.

### [Version 2.2.0 - 2022/11/24](https://github.com/addupsolutions/AddUp.FakeRabbitMQ/releases/tag/v2.2.0)

* A few types in the implementation of the fake server are now `public`. This may prove useful in order to examine the inners of the server for tests purpose. See [PR #115](https://github.com/addupsolutions/AddUp.FakeRabbitMQ/pull/115) for details.
* Better compliance: newly declared queues are now bound to RabbitMQ's default exchange. See [PR #116](https://github.com/addupsolutions/AddUp.FakeRabbitMQ/pull/116) for details.

### [Version 2.1.0 - 2022/10/11](https://github.com/addupsolutions/AddUp.FakeRabbitMQ/releases/tag/v2.1.0)

* Updated **RabbitMQ.Client** to version [6.4.0](https://github.com/rabbitmq/rabbitmq-dotnet-client/blob/main/CHANGELOG.md#changes-between-631-and-640)

### [Version 2.0.0 - 2022/03/12](https://github.com/addupsolutions/AddUp.FakeRabbitMQ/releases/tag/v2.0.0)

* Based on **RabbitMQ.Client** version 6.2.4

### [Version 1.5.1 - 2022/03/12](https://github.com/addupsolutions/AddUp.FakeRabbitMQ/releases/tag/v1.5.1)

* Updated dependencies (obviously except for **RabbitMQ.Client** that is still version 5.2.0)

### [Version 1.5.0 - 2021/11/10](https://github.com/addupsolutions/AddUp.FakeRabbitMQ/releases/tag/v1.5.0)

> Mostly cleanup of the codebase as preparatory work for the v6 client implementation

* Code cleanup:
  * Removed useless overloads and members in `FakeModel`.
  * Refactored Unit Tests (split `IModel` tests into several classes, got rid of the _Arrange_, _Act_ and _Assert_ comments, renamed methods) + added a few ones.
* No-op implementation in `IModel.TxSelect`, `IModel.TxCommit` and `IModel.TxRollback` instead of throwing.
* Implemented `IModel.MessageCount(queue)` and `IModel.ConsumerCount(queue)` based on `QueueDeclarePassive`.
* `IModel.QueuePurge` now returns the number of purged messages.

### [Version 1.4.0 - 2021/11/06](https://github.com/addupsolutions/AddUp.FakeRabbitMQ/releases/tag/v1.4.0)

> This release merges the PR by @inbarbarkai. They are one year-old, and I'm ashamed it took me this long to merge them. Because I'm now _watching_ the repository, I should need less time to react in the future...
> Once again thanks for his contribution.

* BUGFIX: #30. `QueueDeclarePassive` now throws if the queue does not exist. Similarly, `ExchangeDeclarePassive` throws if the exchange does not exist.
* FEATURE: #29. Support for the [Alternate Exchange Feature](https://www.rabbitmq.com/ae.html).
* BUGFIX: #28. `DefaultBasicConsumer.IsRunning` property is now correctly returning true/false.

### [Version 1.3.2 - 2020/11/23](https://github.com/addupsolutions/AddUp.FakeRabbitMQ/releases/tag/v1.3.2)

* BUGFIX: #27. It was impossible to create a connection after having created and closed a previous connection.

### [Version 1.3.1 - 2020/11/23](https://github.com/addupsolutions/AddUp.FakeRabbitMQ/releases/tag/v1.3.1)

* BUGFIX: #25. Now it is possible to close a `Channel` after its connection was closed without the `Channel.Close` method throwing (this is consistent with how **RabbitMQ.Client** behaves).

### [Version 1.3.0 - 2020/11/09](https://github.com/addupsolutions/AddUp.FakeRabbitMQ/releases/tag/v1.3.0)

Most of the work in this release was contributed by @inbarbarkai. Thanks to him!

* As suggested by @inbarbarkai: Basic support for `IModel.ConfirmSelect` and the `IModel.WaitForConfirms*` family.
* Support for `IModel.CreateBasicPublishBatch` was added thanks to PR #21 by @inbarbarkai.
* Consumers that implement both `IBasicConsumer` **and** `IAsyncBasicConsumer` are correctly handled by `IModel.BasicConsume` and `IModel.BasicCancel` thanks to PR #23 by @inbarbarkai.

### [Version 1.2.3 - 2020/10/04](https://github.com/addupsolutions/AddUp.FakeRabbitMQ/releases/tag/v1.2.3)

* Renamed from **AddUp.RabbitMQ.Fakes** to **AddUp.FakeRabbitMQ**.

### [Version 1.2.2 - 2020/06/02](https://github.com/addupsolutions/AddUp.RabbitMQ.Fakes/releases/tag/v1.2.2)

* BUGFIX: Closing a connection could throw if owned models were closed before.

### [Version 1.2.1 - 2020/05/30](https://github.com/addupsolutions/AddUp.RabbitMQ.Fakes/releases/tag/v1.2.1)

* Updated to **RabbitMQ.Client** to version [5.2.0](https://github.com/rabbitmq/rabbitmq-dotnet-client/blob/master/CHANGELOG.md#changes-between-512-and-520)

### [Version 1.2.0 - 2019/12/11](https://github.com/addupsolutions/AddUp.RabbitMQ.Fakes/releases/tag/v1.2.0)

* First released version of **AddUp.RabbitMQ.Fakes**. Based on [RabbitMQ.Client version 5.1.2](https://www.nuget.org/packages/RabbitMQ.Client/5.1.2)
* _NB: the version starts at 1.2.0 so as not to collide with previous internal versions._

## License

This work is provided under the terms of the [MIT License](LICENSE).
